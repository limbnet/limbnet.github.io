DataStream=function(a,b,c){this._byteOffset=b||0;a instanceof ArrayBuffer?this.buffer=a:"object"==typeof a?(this.dataView=a,b&&(this._byteOffset+=b)):this.buffer=new ArrayBuffer(a||1);this.position=0;this.endianness=null==c?DataStream.LITTLE_ENDIAN:c};DataStream.prototype={};
void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=
Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT);DataStream.prototype.save=function(a){var b=new Blob(this.buffer),c=window.webkitURL||window.URL;if(c&&c.createObjectURL){var b=c.createObjectURL(b),e=document.createElement("a");e.setAttribute("href",b);e.setAttribute("download",a);e.click();c.revokeObjectURL(b)}else throw"DataStream.save: Can't create object URL.";};DataStream.BIG_ENDIAN=!1;DataStream.LITTLE_ENDIAN=!0;
DataStream.prototype._dynamicSize=!0;Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(a){a||this._trimAlloc();this._dynamicSize=a}});DataStream.prototype._byteLength=0;Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}});
Object.defineProperty(DataStream.prototype,"buffer",{get:function(){this._trimAlloc();return this._buffer},set:function(a){this._buffer=a;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(a){this._byteOffset=a;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._buffer.byteLength}});
Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(a){this._byteOffset=a.byteOffset;this._buffer=a.buffer;this._dataView=new DataView(this._buffer,this._byteOffset);this._byteLength=this._byteOffset+a.byteLength}});
DataStream.prototype._realloc=function(a){if(this._dynamicSize){a=this._byteOffset+this.position+a;var b=this._buffer.byteLength;if(a<=b)a>this._byteLength&&(this._byteLength=a);else{for(1>b&&(b=1);a>b;)b*=2;var b=new ArrayBuffer(b),c=new Uint8Array(this._buffer);(new Uint8Array(b,0,c.length)).set(c);this.buffer=b;this._byteLength=a}}};
DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var a=new ArrayBuffer(this._byteLength),b=new Uint8Array(a),c=new Uint8Array(this._buffer,0,b.length);b.set(c);this.buffer=a}};DataStream.prototype.seek=function(a){a=Math.max(0,Math.min(this.byteLength,a));this.position=isNaN(a)||!isFinite(a)?0:a};DataStream.prototype.isEof=function(){return this.position>=this.byteLength};
DataStream.prototype.mapInt32Array=function(a,b){this._realloc(4*a);var c=new Int32Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=4*a;return c};DataStream.prototype.mapInt16Array=function(a,b){this._realloc(2*a);var c=new Int16Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=2*a;return c};
DataStream.prototype.mapInt8Array=function(a){this._realloc(1*a);var b=new Int8Array(this._buffer,this.byteOffset+this.position,a);this.position+=1*a;return b};DataStream.prototype.mapUint32Array=function(a,b){this._realloc(4*a);var c=new Uint32Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=4*a;return c};
DataStream.prototype.mapUint16Array=function(a,b){this._realloc(2*a);var c=new Uint16Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=2*a;return c};DataStream.prototype.mapUint8Array=function(a){this._realloc(1*a);var b=new Uint8Array(this._buffer,this.byteOffset+this.position,a);this.position+=1*a;return b};
DataStream.prototype.mapFloat64Array=function(a,b){this._realloc(8*a);var c=new Float64Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=8*a;return c};DataStream.prototype.mapFloat32Array=function(a,b){this._realloc(4*a);var c=new Float32Array(this._buffer,this.byteOffset+this.position,a);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=4*a;return c};
DataStream.prototype.readInt32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Int32Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.readInt16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var c=new Int16Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.readInt8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Int8Array(a);DataStream.memcpy(b.buffer,0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT);this.position+=b.byteLength;return b};
DataStream.prototype.readUint32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Uint32Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.readUint16Array=function(a,b){a=null==a?this.byteLength-this.position/2:a;var c=new Uint16Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.readUint8Array=function(a){a=null==a?this.byteLength-this.position:a;var b=new Uint8Array(a);DataStream.memcpy(b.buffer,0,this.buffer,this.byteOffset+this.position,a*b.BYTES_PER_ELEMENT);this.position+=b.byteLength;return b};
DataStream.prototype.readFloat64Array=function(a,b){a=null==a?this.byteLength-this.position/8:a;var c=new Float64Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.readFloat32Array=function(a,b){a=null==a?this.byteLength-this.position/4:a;var c=new Float32Array(a);DataStream.memcpy(c.buffer,0,this.buffer,this.byteOffset+this.position,a*c.BYTES_PER_ELEMENT);DataStream.arrayToNative(c,null==b?this.endianness:b);this.position+=c.byteLength;return c};
DataStream.prototype.writeInt32Array=function(a,b){this._realloc(4*a.length);if(a instanceof Int32Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapInt32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeInt32(a[c],b)};
DataStream.prototype.writeInt16Array=function(a,b){this._realloc(2*a.length);if(a instanceof Int16Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapInt16Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeInt16(a[c],b)};
DataStream.prototype.writeInt8Array=function(a){this._realloc(1*a.length);if(a instanceof Int8Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapInt8Array(a.length);else for(var b=0;b<a.length;b++)this.writeInt8(a[b])};
DataStream.prototype.writeUint32Array=function(a,b){this._realloc(4*a.length);if(a instanceof Uint32Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapUint32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeUint32(a[c],b)};
DataStream.prototype.writeUint16Array=function(a,b){this._realloc(2*a.length);if(a instanceof Uint16Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapUint16Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeUint16(a[c],b)};
DataStream.prototype.writeUint8Array=function(a){this._realloc(1*a.length);if(a instanceof Uint8Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapUint8Array(a.length);else for(var b=0;b<a.length;b++)this.writeUint8(a[b])};
DataStream.prototype.writeFloat64Array=function(a,b){this._realloc(8*a.length);if(a instanceof Float64Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapFloat64Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeFloat64(a[c],b)};
DataStream.prototype.writeFloat32Array=function(a,b){this._realloc(4*a.length);if(a instanceof Float32Array&&0==(this.byteOffset+this.position)%a.BYTES_PER_ELEMENT)DataStream.memcpy(this._buffer,this.byteOffset+this.position,a.buffer,a.byteOffset,a.byteLength),this.mapFloat32Array(a.length,b);else for(var c=0;c<a.length;c++)this.writeFloat32(a[c],b)};DataStream.prototype.readInt32=function(a){a=this._dataView.getInt32(this.position,null==a?this.endianness:a);this.position+=4;return a};
DataStream.prototype.readInt16=function(a){a=this._dataView.getInt16(this.position,null==a?this.endianness:a);this.position+=2;return a};DataStream.prototype.readInt8=function(){var a=this._dataView.getInt8(this.position);this.position+=1;return a};DataStream.prototype.readUint32=function(a){a=this._dataView.getUint32(this.position,null==a?this.endianness:a);this.position+=4;return a};
DataStream.prototype.readUint16=function(a){a=this._dataView.getUint16(this.position,null==a?this.endianness:a);this.position+=2;return a};DataStream.prototype.readUint8=function(){var a=this._dataView.getUint8(this.position);this.position+=1;return a};DataStream.prototype.readFloat32=function(a){a=this._dataView.getFloat32(this.position,null==a?this.endianness:a);this.position+=4;return a};
DataStream.prototype.readFloat64=function(a){a=this._dataView.getFloat64(this.position,null==a?this.endianness:a);this.position+=8;return a};DataStream.prototype.writeInt32=function(a,b){this._realloc(4);this._dataView.setInt32(this.position,a,null==b?this.endianness:b);this.position+=4};DataStream.prototype.writeInt16=function(a,b){this._realloc(2);this._dataView.setInt16(this.position,a,null==b?this.endianness:b);this.position+=2};
DataStream.prototype.writeInt8=function(a){this._realloc(1);this._dataView.setInt8(this.position,a);this.position+=1};DataStream.prototype.writeUint32=function(a,b){this._realloc(4);this._dataView.setUint32(this.position,a,null==b?this.endianness:b);this.position+=4};DataStream.prototype.writeUint16=function(a,b){this._realloc(2);this._dataView.setUint16(this.position,a,null==b?this.endianness:b);this.position+=2};
DataStream.prototype.writeUint8=function(a){this._realloc(1);this._dataView.setUint8(this.position,a);this.position+=1};DataStream.prototype.writeFloat32=function(a,b){this._realloc(4);this._dataView.setFloat32(this.position,a,null==b?this.endianness:b);this.position+=4};DataStream.prototype.writeFloat64=function(a,b){this._realloc(8);this._dataView.setFloat64(this.position,a,null==b?this.endianness:b);this.position+=8};DataStream.endianness=0<(new Int8Array((new Int16Array([1])).buffer))[0];
DataStream.memcpy=function(a,b,c,e,d){a=new Uint8Array(a,b,d);c=new Uint8Array(c,e,d);a.set(c)};DataStream.arrayToNative=function(a,b){return b==this.endianness?a:this.flipArrayEndianness(a)};DataStream.nativeToEndian=function(a,b){return this.endianness==b?a:this.flipArrayEndianness(a)};
DataStream.flipArrayEndianness=function(a){for(var b=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),c=0;c<a.byteLength;c+=a.BYTES_PER_ELEMENT)for(var e=c+a.BYTES_PER_ELEMENT-1,d=c;e>d;e--,d++){var h=b[d];b[d]=b[e];b[e]=h}return a};DataStream.createStringFromArray=function(a){for(var b=[],c=0;c<a.length;c+=32768)b.push(String.fromCharCode.apply(null,a.subarray(c,c+32768)));return b.join("")};DataStream.prototype.failurePosition=0;
DataStream.prototype.readStruct=function(a){for(var b={},c,e=this.position,d=0;d<a.length;d+=2){c=a[d+1];c=this.readType(c,b);if(null==c)return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=e,null;b[a[d]]=c}return b};DataStream.prototype.readUCS2String=function(a,b){return DataStream.createStringFromArray(this.readUint16Array(a,b))};
DataStream.prototype.writeUCS2String=function(a,b,c){null==c&&(c=a.length);for(var e=0;e<a.length&&e<c;e++)this.writeUint16(a.charCodeAt(e),b);for(;e<c;e++)this.writeUint16(0)};DataStream.prototype.readString=function(a,b){return null==b||"ASCII"==b?DataStream.createStringFromArray(this.mapUint8Array(null==a?this.byteLength-this.position:a)):(new TextDecoder(b)).decode(this.mapUint8Array(a))};
DataStream.prototype.writeString=function(a,b,c){if(null==b||"ASCII"==b)if(null!=c){var e=Math.min(a.length,c);for(b=0;b<e;b++)this.writeUint8(a.charCodeAt(b));for(;b<c;b++)this.writeUint8(0)}else for(b=0;b<a.length;b++)this.writeUint8(a.charCodeAt(b));else this.writeUint8Array((new TextEncoder(b)).encode(a.substring(0,c)))};
DataStream.prototype.readCString=function(a){var b=this.byteLength-this.position,c=new Uint8Array(this._buffer,this._byteOffset+this.position),e=b;null!=a&&(e=Math.min(a,b));for(var d=0;d<e&&0!=c[d];d++);c=DataStream.createStringFromArray(this.mapUint8Array(d));null!=a?this.position+=e-d:d!=b&&(this.position+=1);return c};
DataStream.prototype.writeCString=function(a,b){var c;if(null!=b){var e=Math.min(a.length,b);for(c=0;c<e;c++)this.writeUint8(a.charCodeAt(c));for(;c<b;c++)this.writeUint8(0)}else{for(c=0;c<a.length;c++)this.writeUint8(a.charCodeAt(c));this.writeUint8(0)}};
DataStream.prototype.readType=function(a,b){if("function"==typeof a)return a(this,b);if("object"==typeof a&&!(a instanceof Array))return a.get(this,b);if(a instanceof Array&&3!=a.length)return this.readStruct(a,b);var c=null,e=null,d="ASCII",h=this.position;if("string"==typeof a&&/:/.test(a)){var g=a.split(":");a=g[0];var f=g[1];e=null!=b[f]?parseInt(b[f]):parseInt(g[1])}"string"==typeof a&&/,/.test(a)&&(g=a.split(","),a=g[0],d=parseInt(g[1]));switch(a){case "uint8":c=this.readUint8();break;case "int8":c=
this.readInt8();break;case "uint16":c=this.readUint16(this.endianness);break;case "int16":c=this.readInt16(this.endianness);break;case "uint32":c=this.readUint32(this.endianness);break;case "int32":c=this.readInt32(this.endianness);break;case "float32":c=this.readFloat32(this.endianness);break;case "float64":c=this.readFloat64(this.endianness);break;case "uint16be":c=this.readUint16(DataStream.BIG_ENDIAN);break;case "int16be":c=this.readInt16(DataStream.BIG_ENDIAN);break;case "uint32be":c=this.readUint32(DataStream.BIG_ENDIAN);
break;case "int32be":c=this.readInt32(DataStream.BIG_ENDIAN);break;case "float32be":c=this.readFloat32(DataStream.BIG_ENDIAN);break;case "float64be":c=this.readFloat64(DataStream.BIG_ENDIAN);break;case "uint16le":c=this.readUint16(DataStream.LITTLE_ENDIAN);break;case "int16le":c=this.readInt16(DataStream.LITTLE_ENDIAN);break;case "uint32le":c=this.readUint32(DataStream.LITTLE_ENDIAN);break;case "int32le":c=this.readInt32(DataStream.LITTLE_ENDIAN);break;case "float32le":c=this.readFloat32(DataStream.LITTLE_ENDIAN);
break;case "float64le":c=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case "cstring":c=this.readCString(e);break;case "string":c=this.readString(e,d);break;case "u16string":c=this.readUCS2String(e,this.endianness);break;case "u16stringle":c=this.readUCS2String(e,DataStream.LITTLE_ENDIAN);break;case "u16stringbe":c=this.readUCS2String(e,DataStream.BIG_ENDIAN);break;default:if(3==a.length)if(g=a[1],f=a[2],d="function"==typeof f?f(b,this,a):"string"==typeof f&&null!=b[f]?parseInt(b[f]):parseInt(f),
"string"==typeof g){var k=g.replace(/(le|be)$/,""),l=null;/le$/.test(g)?l=DataStream.LITTLE_ENDIAN:/be$/.test(g)&&(l=DataStream.BIG_ENDIAN);"*"==f&&(d=null);switch(k){case "uint8":c=this.readUint8Array(d);break;case "uint16":c=this.readUint16Array(d,l);break;case "uint32":c=this.readUint32Array(d,l);break;case "int8":c=this.readInt8Array(d);break;case "int16":c=this.readInt16Array(d,l);break;case "int32":c=this.readInt32Array(d,l);break;case "float32":c=this.readFloat32Array(d,l);break;case "float64":c=
this.readFloat64Array(d,l);break;case "cstring":case "utf16string":case "string":if(null==d)for(c=[];!this.isEof();){f=this.readType(g,b);if(null==f)break;c.push(f)}else for(c=Array(d),k=0;k<d;k++)c[k]=this.readType(g,b)}}else if("*"==f)for(c=[],this.buffer;;){f=this.position;try{k=this.readType(g,b);if(null==k){this.position=f;break}c.push(k)}catch(m){this.position=f;break}}else for(c=Array(d),k=0;k<d;k++){f=this.readType(g,b);if(null==f)return null;c[k]=f}}null!=e&&(this.position=h+e);return c};
DataStream.prototype.writeStruct=function(a,b){for(var c=0;c<a.length;c+=2)this.writeType(a[c+1],b[a[c]],b)};
DataStream.prototype.writeType=function(a,b,c){if("function"==typeof a)return a(this,b);if("object"==typeof a&&!(a instanceof Array))return a.set(this,b,c);c=null;var e="ASCII",d=this.position;if("string"==typeof a&&/:/.test(a)){var h=a.split(":");a=h[0];c=parseInt(h[1])}"string"==typeof a&&/,/.test(a)&&(h=a.split(","),a=h[0],e=parseInt(h[1]));switch(a){case "uint8":this.writeUint8(b);break;case "int8":this.writeInt8(b);break;case "uint16":this.writeUint16(b,this.endianness);break;case "int16":this.writeInt16(b,
this.endianness);break;case "uint32":this.writeUint32(b,this.endianness);break;case "int32":this.writeInt32(b,this.endianness);break;case "float32":this.writeFloat32(b,this.endianness);break;case "float64":this.writeFloat64(b,this.endianness);break;case "uint16be":this.writeUint16(b,DataStream.BIG_ENDIAN);break;case "int16be":this.writeInt16(b,DataStream.BIG_ENDIAN);break;case "uint32be":this.writeUint32(b,DataStream.BIG_ENDIAN);break;case "int32be":this.writeInt32(b,DataStream.BIG_ENDIAN);break;
case "float32be":this.writeFloat32(b,DataStream.BIG_ENDIAN);break;case "float64be":this.writeFloat64(b,DataStream.BIG_ENDIAN);break;case "uint16le":this.writeUint16(b,DataStream.LITTLE_ENDIAN);break;case "int16le":this.writeInt16(b,DataStream.LITTLE_ENDIAN);break;case "uint32le":this.writeUint32(b,DataStream.LITTLE_ENDIAN);break;case "int32le":this.writeInt32(b,DataStream.LITTLE_ENDIAN);break;case "float32le":this.writeFloat32(b,DataStream.LITTLE_ENDIAN);break;case "float64le":this.writeFloat64(b,
DataStream.LITTLE_ENDIAN);break;case "cstring":this.writeCString(b,c);break;case "string":this.writeString(b,e,c);break;case "u16string":this.writeUCS2String(b,this.endianness,c);break;case "u16stringle":this.writeUCS2String(b,DataStream.LITTLE_ENDIAN,c);break;case "u16stringbe":this.writeUCS2String(b,DataStream.BIG_ENDIAN,c);break;default:if(3==a.length)for(a=a[1],h=0;h<b.length;h++)this.writeType(a,b[h]);else this.writeStruct(a,b)}null!=c&&(this.position=d,this._realloc(c),this.position=d+c)};
"function"===typeof define&&define.amd&&define("DataStream",[],function(){return DataStream});"object"===typeof module&&module&&module.exports&&(module.exports=DataStream);

